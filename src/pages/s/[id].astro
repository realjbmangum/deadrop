---
export const prerender = false;
import { getBrandConfig } from '../../lib/config';
const kv = Astro.locals.runtime.env.DEADROP_SECRETS;
const brand = await getBrandConfig(kv);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{brand.name} — Secure Secret</title>
    <meta name="description" content="Someone sent you a self-destructing secret." />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
  </head>
  <body class="min-h-screen bg-[#0D0D12] text-gray-200 antialiased">

    <!-- Atmospheric glow -->
    <div aria-hidden="true" class="fixed inset-0 pointer-events-none overflow-hidden">
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/3 w-[600px] h-[600px] rounded-full"
           style="background: radial-gradient(circle, rgba(0,255,136,0.05) 0%, transparent 65%);"></div>
    </div>

    <!-- Dot grid -->
    <div aria-hidden="true" class="fixed inset-0 pointer-events-none"
         style="background-image: radial-gradient(circle, rgba(255,255,255,0.06) 1px, transparent 1px); background-size: 28px 28px; opacity: 0.4;"></div>

    <main class="relative max-w-[560px] mx-auto px-5 py-12 sm:py-20">

      <!-- Header -->
      <header class="mb-10 text-center reveal">
        <a href="/" class="inline-block focus-visible:outline focus-visible:outline-2 focus-visible:outline-[#00FF88] focus-visible:outline-offset-4 rounded">
          <h1 class="font-mono font-extrabold text-white leading-none" style="font-size: clamp(1.8rem, 6vw, 2.8rem); font-family: 'JetBrains Mono', monospace; letter-spacing: -0.02em;">
            {brand.name}<span class="text-[#00FF88]">_</span>
          </h1>
        </a>
        <p class="mt-2 text-[11px] font-mono text-[#3A3A5A] tracking-[0.2em] uppercase">incoming secret</p>
      </header>

      <!-- PRE-REVEAL (warning + optional passphrase + button) -->
      <div id="pre-reveal" class="reveal" style="animation-delay: 0.08s">

        <!-- Warning -->
        <div class="warn-card mb-6">
          <div class="flex gap-4">
            <svg aria-hidden="true" class="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div>
              <p class="text-amber-200 font-mono font-semibold text-sm mb-1">ONE-TIME SECRET</p>
              <p class="text-amber-400/70 text-sm leading-relaxed" style="font-family: 'IBM Plex Sans', sans-serif;">
                This secret will be <strong class="text-amber-300 font-semibold">permanently destroyed</strong> after you view it. Make sure you're ready to copy it before revealing.
              </p>
            </div>
          </div>
        </div>

        <!-- Passphrase input (shown when link has `p:` prefix) -->
        <div id="passphrase-section" class="hidden mb-5">
          <div class="form-card p-5">
            <label class="field-label mb-3 block">PASSPHRASE REQUIRED</label>
            <p class="text-sm text-[#5A5A7A] mb-4" style="font-family: 'IBM Plex Sans', sans-serif;">
              The sender added a passphrase to this secret. Enter it to decrypt.
            </p>
            <input
              type="password"
              id="passphrase-input"
              placeholder="Enter passphrase..."
              autocomplete="off"
              class="w-full bg-[#080810] border border-[#1A1A2E] rounded-lg px-4 py-2.5 text-[#E0E0F0] font-mono text-sm placeholder-[#2E2E4A] focus:outline-none focus:border-[#00FF88] focus:ring-1 focus:ring-[#00FF88]/20 transition-all"
            />
            <p id="passphrase-error" class="hidden mt-2 text-red-400 text-xs font-mono"></p>
          </div>
        </div>

        <!-- Reveal button -->
        <button id="reveal-btn" type="button" class="reveal-btn">
          REVEAL SECRET
        </button>

      </div>

      <!-- LOADING -->
      <div id="loading-state" class="hidden text-center py-14" role="status" aria-label="Decrypting secret">
        <div aria-hidden="true" class="inline-block w-6 h-6 border-2 border-[#1A1A2E] border-t-[#00FF88] rounded-full animate-spin mb-5"></div>
        <p class="text-[#4A4A6A] text-sm font-mono tracking-wider">DECRYPTING<span class="dots-anim">...</span></p>
      </div>

      <!-- REVEALED -->
      <div id="revealed-section" class="hidden">

        <div class="form-card overflow-hidden">
          <div class="flex items-center justify-between px-5 py-3 border-b border-[#141420]">
            <span class="field-label">DECRYPTED SECRET</span>
            <button
              id="copy-secret-btn"
              type="button"
              class="copy-btn"
            >COPY</button>
          </div>
          <pre
            id="secret-display"
            class="px-5 py-5 text-[#00FF88] font-mono text-sm whitespace-pre-wrap break-all leading-relaxed max-h-[400px] overflow-y-auto"
          ></pre>
        </div>

        <!-- Destroyed banner -->
        <div class="mt-5 rounded-xl border border-red-500/20 bg-red-500/[0.04] p-4">
          <div class="flex items-center gap-2.5 mb-1.5">
            <svg aria-hidden="true" class="w-4 h-4 text-red-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            <span class="text-red-400 font-mono font-semibold text-sm tracking-wide">DESTROYED</span>
          </div>
          <p class="text-red-400/50 text-xs font-mono">This secret has been permanently deleted. This link will not work again.</p>
        </div>
      </div>

      <!-- ERROR -->
      <div id="error-section" class="hidden">
        <div class="form-card p-10 text-center">
          <div class="w-14 h-14 rounded-full bg-[#0A0A14] border border-[#1A1A2E] flex items-center justify-center mx-auto mb-5">
            <svg aria-hidden="true" class="w-7 h-7 text-[#3A3A5A]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
          </div>
          <h2 class="font-mono font-bold text-white text-lg mb-2 tracking-tight">NOT FOUND</h2>
          <p id="error-message" class="text-[#5A5A7A] text-sm leading-relaxed" style="font-family: 'IBM Plex Sans', sans-serif;">
            This secret no longer exists. It may have already been viewed or expired.
          </p>
        </div>
      </div>

      <!-- Footer -->
      <footer class="mt-16 pt-6 border-t border-[#141420] text-center">
        <a href="/" class="text-[11px] font-mono text-[#2E2E48] hover:text-[#00FF88] transition-colors focus-visible:outline focus-visible:outline-2 focus-visible:outline-[#00FF88] focus-visible:outline-offset-2 rounded">
          SEND YOUR OWN SECRET WITH {brand.name}_
        </a>
      </footer>

    </main>

    <style>
      body { font-family: 'IBM Plex Sans', system-ui, sans-serif; }

      .reveal { opacity: 0; transform: translateY(12px); animation: revealUp 0.5s ease forwards; }
      @keyframes revealUp { to { opacity: 1; transform: translateY(0); } }

      .form-card {
        background: #111119;
        border: 1px solid #1C1C2C;
        border-radius: 14px;
      }

      .field-label {
        font-family: 'JetBrains Mono', monospace;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.18em;
        color: #5A5A7A;
        text-transform: uppercase;
      }

      .warn-card {
        background: rgba(245, 158, 11, 0.04);
        border: 1px solid rgba(245, 158, 11, 0.15);
        border-radius: 14px;
        padding: 1.25rem 1.5rem;
      }

      .reveal-btn {
        width: 100%;
        padding: 16px;
        background: #00FF88;
        color: #050508;
        font-family: 'JetBrains Mono', monospace;
        font-size: 14px;
        font-weight: 800;
        letter-spacing: 0.1em;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .reveal-btn:hover {
        background: #00FFB0;
        box-shadow: 0 0 24px rgba(0,255,136,0.35), 0 4px 16px rgba(0,255,136,0.2);
        transform: translateY(-1px);
      }
      .reveal-btn:active { transform: scale(0.99); }

      .copy-btn {
        padding: 5px 12px;
        background: rgba(0,255,136,0.08);
        color: #00FF88;
        font-family: 'JetBrains Mono', monospace;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.1em;
        border: 1px solid rgba(0,255,136,0.2);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .copy-btn:hover { background: rgba(0,255,136,0.15); border-color: rgba(0,255,136,0.4); }

      .dots-anim { animation: dots 1.4s steps(4, end) infinite; }
      @keyframes dots {
        0%   { content: ''; }
        25%  { content: '.'; }
        50%  { content: '..'; }
        75%  { content: '...'; }
        100% { content: ''; }
      }

      @keyframes secretReveal {
        0%  { opacity: 0; transform: translateY(8px); }
        100%{ opacity: 1; transform: translateY(0); }
      }
      .secret-revealed { animation: secretReveal 0.35s ease forwards; }

      @media (prefers-reduced-motion: reduce) {
        .reveal, .dots-anim, .secret-revealed { animation: none !important; opacity: 1; transform: none; }
      }
    </style>

    <script>
      import { decryptSecret, decryptWithPassphrase } from '../../lib/crypto';

      const preReveal       = document.getElementById('pre-reveal')!;
      const loadingState    = document.getElementById('loading-state')!;
      const revealedSection = document.getElementById('revealed-section')!;
      const errorSection    = document.getElementById('error-section')!;
      const errorMessage    = document.getElementById('error-message')!;
      const revealBtn       = document.getElementById('reveal-btn') as HTMLButtonElement;
      const ppSection       = document.getElementById('passphrase-section')!;
      const ppInput         = document.getElementById('passphrase-input') as HTMLInputElement;
      const ppError         = document.getElementById('passphrase-error')!;
      const secretDisplay   = document.getElementById('secret-display')!;
      const copySecretBtn   = document.getElementById('copy-secret-btn')!;

      function showError(msg: string) {
        preReveal.classList.add('hidden');
        loadingState.classList.add('hidden');
        revealedSection.classList.add('hidden');
        errorSection.classList.remove('hidden');
        errorMessage.textContent = msg;
      }

      function showRevealed(plaintext: string) {
        loadingState.classList.add('hidden');
        secretDisplay.textContent = plaintext;
        revealedSection.classList.remove('hidden');
        revealedSection.classList.add('secret-revealed');
      }

      // Parse fragment on load
      const fragment = window.location.hash.slice(1);
      const isPassphrase = fragment.startsWith('p:');

      if (!fragment) {
        showError('Invalid link — missing decryption key. The key should be in the URL after the # symbol.');
      } else if (isPassphrase) {
        ppSection.classList.remove('hidden');
        ppInput.focus();
        // Allow Enter key on passphrase input
        ppInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') revealBtn.click();
        });
      }

      revealBtn.addEventListener('click', async () => {
        if (!fragment) return;

        // For passphrase mode, validate input
        if (isPassphrase) {
          ppError.classList.add('hidden');
          if (!ppInput.value.trim()) {
            ppError.textContent = 'Please enter the passphrase.';
            ppError.classList.remove('hidden');
            ppInput.focus();
            return;
          }
        }

        const pathParts = window.location.pathname.split('/');
        const id = pathParts[pathParts.length - 1];
        if (!id) { showError('Invalid link — missing secret ID.'); return; }

        preReveal.classList.add('hidden');
        loadingState.classList.remove('hidden');

        try {
          const res = await fetch(`/api/secret/${id}`);

          if (res.status === 404) {
            showError('This secret no longer exists. It may have already been viewed or expired.');
            return;
          }
          if (!res.ok) {
            const d = await res.json().catch(() => ({ error: 'Request failed' }));
            throw new Error(d.error || `Server error (${res.status})`);
          }

          const { ciphertext, iv } = await res.json();

          let plaintext: string;
          if (isPassphrase) {
            const saltB64 = fragment.slice(2); // strip 'p:'
            try {
              plaintext = await decryptWithPassphrase(ciphertext, iv, saltB64, ppInput.value);
            } catch {
              // Wrong passphrase — the view was consumed. Show clear message.
              loadingState.classList.add('hidden');
              preReveal.classList.remove('hidden');
              ppError.textContent = 'Wrong passphrase. Note: one view was consumed.';
              ppError.classList.remove('hidden');
              ppInput.value = '';
              ppInput.focus();
              return;
            }
          } else {
            plaintext = await decryptSecret(ciphertext, iv, fragment);
          }

          showRevealed(plaintext);

        } catch (err: any) {
          if (err.message?.includes('decrypt') || err.name === 'OperationError') {
            showError('Decryption failed. The link may be corrupted or incomplete.');
          } else {
            showError(err.message || 'Something went wrong. Please try again.');
          }
        }
      });

      // Copy secret
      copySecretBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(secretDisplay.textContent || '');
          copySecretBtn.textContent = 'COPIED!';
          setTimeout(() => { copySecretBtn.textContent = 'COPY'; }, 2000);
        } catch {
          const range = document.createRange();
          range.selectNodeContents(secretDisplay);
          window.getSelection()?.removeAllRanges();
          window.getSelection()?.addRange(range);
        }
      });
    </script>

  </body>
</html>
